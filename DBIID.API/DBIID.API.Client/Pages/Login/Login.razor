@attribute [Route(RoutePaths.Login.Base)]
@layout LoginLayout
@using DBI.DIGI.Components.Atoms.InputAtoms
@using DBI.DIGI.Components.Toast
@using DBIID.API.Client.Extensions
@using DBIID.API.Client.Layout
@using Microsoft.AspNetCore.Components.WebAssembly;
@inject HttpClient Http
@inject JwtAuthenticationStateProvider AuthStateProvider
@inject NavigationManager navigationManager
@inject IToastService toastService


<label>E-mail</label>
<TextInput @bind-Input="email" />

<label>Adgangskode</label>
<TextInput @bind-Input="password" />

<DBI.DIGI.Components.Button Class="DBI.DIGI.Components.ButtonType.Prim" Size="DBI.DIGI.Components.ButtonSize.FullWidth" OnClick="OnLogin" Title="Log ind"></DBI.DIGI.Components.Button>


@code {
    private string email = "jdp@brandogsikring.dk";
    private string password = "test";

    string returnUrl;

    protected override void OnInitialized()
    {
        returnUrl = navigationManager.GetQueryParameter("returnUrl") ?? "/";

    }

    private async Task OnLogin()
    {
        var response = await Http.PostAsJsonAsync("api/auth/login", new { Email = email, Password = password });
        if (response.IsSuccessStatusCode)
        {
            var json = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
            string token = json["token"];
            await AuthStateProvider.SetToken(token);
            toastService.Open(new ToastWithAutoClose()
                {
                    Duration = TimeSpan.FromSeconds(5),
                    Status = ToastStatus.Success,
                    Title = "Du er nu logget ind"
                });

            if (string.IsNullOrWhiteSpace(returnUrl))
            {
                navigationManager.NavigateTo(RoutePaths.Home);
            }
            else
            {
                // Efter login
                navigationManager.NavigateTo(returnUrl);
            }
        }
        else
        {
            toastService.Open(new ToastWithAutoClose()
                {
                    Duration = TimeSpan.FromSeconds(5),
                    Status = ToastStatus.Error,
                    Title = "Du kunne ikke logges ind"
                });
        }
    }
}